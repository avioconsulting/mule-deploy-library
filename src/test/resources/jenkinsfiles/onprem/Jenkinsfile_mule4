package jenkinsfiles.cloudhub

pipeline {
    agent any

    environment {
        anypoint_credentials_usr = 'bwied_avio2'
        // set this environment variable unit test run to keep out of source control
        //anypoint_password = 'foobar'
        anypoint_org_id = 'f2ea2cb4-c600-4bb5-88e8-e952ff5591ee'
        version = "1.0.${env.BUILD_NUMBER}"
        fileName = getMuleFileName appName: 'mule4testapp',
                                   appVersion: version,
                                   muleVersion: '4.1.4'
    }

    stages {
        stage('Build') {
            steps {
                sh "mvn org.codehaus.mojo:versions-maven-plugin:2.7:set -DnewVersion=${env.version} -DgenerateBackupPoms=false -DprocessAllModules=true -f MULE4_PROJECT_PATH/pom.xml"
                sh "mvn -f MULE4_PROJECT_PATH/pom.xml clean package"
            }
        }

        stage('Deploy') {
            environment {
                anypoint_environment = 'DEV'
            }

            steps {
                muleDeployOnPrem zipFilePath: "MULE4_PROJECT_PATH/${env.fileName}",
                                 appName: 'the-mule4app-2',
                                 targetServerOrClusterName: 'bradytest3',
                                 propertyOverrides: env.BUILD_NUMBER == '2' ? 'our.prop=newvalue' : '',
                                 overrideByChangingFileInZip: 'api.dev.properties'
            }
        }
    }
}
